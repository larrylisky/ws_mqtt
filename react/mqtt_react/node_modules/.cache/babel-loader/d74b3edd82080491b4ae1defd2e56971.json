{"ast":null,"code":"'use strict';\n\nconst WS = require('ws');\n\nconst debug = require('debug')('mqttjs:ws');\n\nconst duplexify = require('duplexify');\n\nconst Transform = require('readable-stream').Transform;\n\nlet WSS_OPTIONS = ['rejectUnauthorized', 'ca', 'cert', 'key', 'pfx', 'passphrase']; // eslint-disable-next-line camelcase\n\nconst IS_BROWSER = typeof process !== 'undefined' && process.title === 'browser' || typeof __webpack_require__ === 'function';\n\nfunction buildUrl(opts, client) {\n  let url = opts.protocol + '://' + opts.hostname + ':' + opts.port + opts.path;\n\n  if (typeof opts.transformWsUrl === 'function') {\n    url = opts.transformWsUrl(url, opts, client);\n  }\n\n  return url;\n}\n\nfunction setDefaultOpts(opts) {\n  let options = opts;\n\n  if (!opts.hostname) {\n    options.hostname = 'localhost';\n  }\n\n  if (!opts.port) {\n    if (opts.protocol === 'wss') {\n      options.port = 443;\n    } else {\n      options.port = 80;\n    }\n  }\n\n  if (!opts.path) {\n    options.path = '/';\n  }\n\n  if (!opts.wsOptions) {\n    options.wsOptions = {};\n  }\n\n  if (!IS_BROWSER && opts.protocol === 'wss') {\n    // Add cert/key/ca etc options\n    WSS_OPTIONS.forEach(function (prop) {\n      if (opts.hasOwnProperty(prop) && !opts.wsOptions.hasOwnProperty(prop)) {\n        options.wsOptions[prop] = opts[prop];\n      }\n    });\n  }\n\n  return options;\n}\n\nfunction setDefaultBrowserOpts(opts) {\n  let options = setDefaultOpts(opts);\n\n  if (!options.hostname) {\n    options.hostname = options.host;\n  }\n\n  if (!options.hostname) {\n    // Throwing an error in a Web Worker if no `hostname` is given, because we\n    // can not determine the `hostname` automatically.  If connecting to\n    // localhost, please supply the `hostname` as an argument.\n    if (typeof document === 'undefined') {\n      throw new Error('Could not determine host. Specify host manually.');\n    }\n\n    const parsed = new URL(document.URL);\n    options.hostname = parsed.hostname;\n\n    if (!options.port) {\n      options.port = parsed.port;\n    }\n  } // objectMode should be defined for logic\n\n\n  if (options.objectMode === undefined) {\n    options.objectMode = !(options.binary === true || options.binary === undefined);\n  }\n\n  return options;\n}\n\nfunction createWebSocket(client, url, opts) {\n  debug('createWebSocket');\n  debug('protocol: ' + opts.protocolId + ' ' + opts.protocolVersion);\n  const websocketSubProtocol = opts.protocolId === 'MQIsdp' && opts.protocolVersion === 3 ? 'mqttv3.1' : 'mqtt';\n  debug('creating new Websocket for url: ' + url + ' and protocol: ' + websocketSubProtocol);\n  let socket = new WS(url, [websocketSubProtocol], opts.wsOptions);\n  return socket;\n}\n\nfunction createBrowserWebSocket(client, opts) {\n  const websocketSubProtocol = opts.protocolId === 'MQIsdp' && opts.protocolVersion === 3 ? 'mqttv3.1' : 'mqtt';\n  let url = buildUrl(opts, client);\n  /* global WebSocket */\n\n  let socket = new WebSocket(url, [websocketSubProtocol]);\n  socket.binaryType = 'arraybuffer';\n  return socket;\n}\n\nfunction streamBuilder(client, opts) {\n  debug('streamBuilder');\n  let options = setDefaultOpts(opts);\n  const url = buildUrl(options, client);\n  let socket = createWebSocket(client, url, options);\n  let webSocketStream = WS.createWebSocketStream(socket, options.wsOptions);\n  webSocketStream.url = url;\n  socket.on('close', () => {\n    webSocketStream.destroy();\n  });\n  return webSocketStream;\n}\n\nfunction browserStreamBuilder(client, opts) {\n  debug('browserStreamBuilder');\n  let stream;\n  let options = setDefaultBrowserOpts(opts); // sets the maximum socket buffer size before throttling\n\n  const bufferSize = options.browserBufferSize || 1024 * 512;\n  const bufferTimeout = opts.browserBufferTimeout || 1000;\n  const coerceToBuffer = !opts.objectMode;\n  let socket = createBrowserWebSocket(client, opts);\n  let proxy = buildProxy(opts, socketWriteBrowser, socketEndBrowser);\n\n  if (!opts.objectMode) {\n    proxy._writev = writev;\n  }\n\n  proxy.on('close', () => {\n    socket.close();\n  });\n  const eventListenerSupport = typeof socket.addEventListener !== 'undefined'; // was already open when passed in\n\n  if (socket.readyState === socket.OPEN) {\n    stream = proxy;\n  } else {\n    stream = stream = duplexify(undefined, undefined, opts);\n\n    if (!opts.objectMode) {\n      stream._writev = writev;\n    }\n\n    if (eventListenerSupport) {\n      socket.addEventListener('open', onopen);\n    } else {\n      socket.onopen = onopen;\n    }\n  }\n\n  stream.socket = socket;\n\n  if (eventListenerSupport) {\n    socket.addEventListener('close', onclose);\n    socket.addEventListener('error', onerror);\n    socket.addEventListener('message', onmessage);\n  } else {\n    socket.onclose = onclose;\n    socket.onerror = onerror;\n    socket.onmessage = onmessage;\n  } // methods for browserStreamBuilder\n\n\n  function buildProxy(options, socketWrite, socketEnd) {\n    let proxy = new Transform({\n      objectModeMode: options.objectMode\n    });\n    proxy._write = socketWrite;\n    proxy._flush = socketEnd;\n    return proxy;\n  }\n\n  function onopen() {\n    stream.setReadable(proxy);\n    stream.setWritable(proxy);\n    stream.emit('connect');\n  }\n\n  function onclose() {\n    stream.end();\n    stream.destroy();\n  }\n\n  function onerror(err) {\n    stream.destroy(err);\n  }\n\n  function onmessage(event) {\n    let data = event.data;\n    if (data instanceof ArrayBuffer) data = Buffer.from(data);else data = Buffer.from(data, 'utf8');\n    proxy.push(data);\n  } // this is to be enabled only if objectMode is false\n\n\n  function writev(chunks, cb) {\n    const buffers = new Array(chunks.length);\n\n    for (let i = 0; i < chunks.length; i++) {\n      if (typeof chunks[i].chunk === 'string') {\n        buffers[i] = Buffer.from(chunks[i], 'utf8');\n      } else {\n        buffers[i] = chunks[i].chunk;\n      }\n    }\n\n    this._write(Buffer.concat(buffers), 'binary', cb);\n  }\n\n  function socketWriteBrowser(chunk, enc, next) {\n    if (socket.bufferedAmount > bufferSize) {\n      // throttle data until buffered amount is reduced.\n      setTimeout(socketWriteBrowser, bufferTimeout, chunk, enc, next);\n    }\n\n    if (coerceToBuffer && typeof chunk === 'string') {\n      chunk = Buffer.from(chunk, 'utf8');\n    }\n\n    try {\n      socket.send(chunk);\n    } catch (err) {\n      return next(err);\n    }\n\n    next();\n  }\n\n  function socketEndBrowser(done) {\n    socket.close();\n    done();\n  } // end methods for browserStreamBuilder\n\n\n  return stream;\n}\n\nif (IS_BROWSER) {\n  module.exports = browserStreamBuilder;\n} else {\n  module.exports = streamBuilder;\n}","map":{"version":3,"sources":["/Users/larry/Software/react/mqtt_react/node_modules/mqtt/lib/connect/ws.js"],"names":["WS","require","debug","duplexify","Transform","WSS_OPTIONS","IS_BROWSER","process","title","__webpack_require__","buildUrl","opts","client","url","protocol","hostname","port","path","transformWsUrl","setDefaultOpts","options","wsOptions","forEach","prop","hasOwnProperty","setDefaultBrowserOpts","host","document","Error","parsed","URL","objectMode","undefined","binary","createWebSocket","protocolId","protocolVersion","websocketSubProtocol","socket","createBrowserWebSocket","WebSocket","binaryType","streamBuilder","webSocketStream","createWebSocketStream","on","destroy","browserStreamBuilder","stream","bufferSize","browserBufferSize","bufferTimeout","browserBufferTimeout","coerceToBuffer","proxy","buildProxy","socketWriteBrowser","socketEndBrowser","_writev","writev","close","eventListenerSupport","addEventListener","readyState","OPEN","onopen","onclose","onerror","onmessage","socketWrite","socketEnd","objectModeMode","_write","_flush","setReadable","setWritable","emit","end","err","event","data","ArrayBuffer","Buffer","from","push","chunks","cb","buffers","Array","length","i","chunk","concat","enc","next","bufferedAmount","setTimeout","send","done","module","exports"],"mappings":"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","sourcesContent":["'use strict'\r\n\r\nconst WS = require('ws')\r\nconst debug = require('debug')('mqttjs:ws')\r\nconst duplexify = require('duplexify')\r\nconst Transform = require('readable-stream').Transform\r\n\r\nlet WSS_OPTIONS = [\r\n  'rejectUnauthorized',\r\n  'ca',\r\n  'cert',\r\n  'key',\r\n  'pfx',\r\n  'passphrase'\r\n]\r\n// eslint-disable-next-line camelcase\r\nconst IS_BROWSER = (typeof process !== 'undefined' && process.title === 'browser') || typeof __webpack_require__ === 'function'\r\nfunction buildUrl (opts, client) {\r\n  let url = opts.protocol + '://' + opts.hostname + ':' + opts.port + opts.path\r\n  if (typeof (opts.transformWsUrl) === 'function') {\r\n    url = opts.transformWsUrl(url, opts, client)\r\n  }\r\n  return url\r\n}\r\n\r\nfunction setDefaultOpts (opts) {\r\n  let options = opts\r\n  if (!opts.hostname) {\r\n    options.hostname = 'localhost'\r\n  }\r\n  if (!opts.port) {\r\n    if (opts.protocol === 'wss') {\r\n      options.port = 443\r\n    } else {\r\n      options.port = 80\r\n    }\r\n  }\r\n  if (!opts.path) {\r\n    options.path = '/'\r\n  }\r\n\r\n  if (!opts.wsOptions) {\r\n    options.wsOptions = {}\r\n  }\r\n  if (!IS_BROWSER && opts.protocol === 'wss') {\r\n    // Add cert/key/ca etc options\r\n    WSS_OPTIONS.forEach(function (prop) {\r\n      if (opts.hasOwnProperty(prop) && !opts.wsOptions.hasOwnProperty(prop)) {\r\n        options.wsOptions[prop] = opts[prop]\r\n      }\r\n    })\r\n  }\r\n\r\n  return options\r\n}\r\n\r\nfunction setDefaultBrowserOpts (opts) {\r\n  let options = setDefaultOpts(opts)\r\n\r\n  if (!options.hostname) {\r\n    options.hostname = options.host\r\n  }\r\n\r\n  if (!options.hostname) {\r\n    // Throwing an error in a Web Worker if no `hostname` is given, because we\r\n    // can not determine the `hostname` automatically.  If connecting to\r\n    // localhost, please supply the `hostname` as an argument.\r\n    if (typeof (document) === 'undefined') {\r\n      throw new Error('Could not determine host. Specify host manually.')\r\n    }\r\n    const parsed = new URL(document.URL)\r\n    options.hostname = parsed.hostname\r\n\r\n    if (!options.port) {\r\n      options.port = parsed.port\r\n    }\r\n  }\r\n\r\n  // objectMode should be defined for logic\r\n  if (options.objectMode === undefined) {\r\n    options.objectMode = !(options.binary === true || options.binary === undefined)\r\n  }\r\n\r\n  return options\r\n}\r\n\r\nfunction createWebSocket (client, url, opts) {\r\n  debug('createWebSocket')\r\n  debug('protocol: ' + opts.protocolId + ' ' + opts.protocolVersion)\r\n  const websocketSubProtocol =\r\n    (opts.protocolId === 'MQIsdp') && (opts.protocolVersion === 3)\r\n      ? 'mqttv3.1'\r\n      : 'mqtt'\r\n\r\n  debug('creating new Websocket for url: ' + url + ' and protocol: ' + websocketSubProtocol)\r\n  let socket = new WS(url, [websocketSubProtocol], opts.wsOptions)\r\n  return socket\r\n}\r\n\r\nfunction createBrowserWebSocket (client, opts) {\r\n  const websocketSubProtocol =\r\n  (opts.protocolId === 'MQIsdp') && (opts.protocolVersion === 3)\r\n    ? 'mqttv3.1'\r\n    : 'mqtt'\r\n\r\n  let url = buildUrl(opts, client)\r\n  /* global WebSocket */\r\n  let socket = new WebSocket(url, [websocketSubProtocol])\r\n  socket.binaryType = 'arraybuffer'\r\n  return socket\r\n}\r\n\r\nfunction streamBuilder (client, opts) {\r\n  debug('streamBuilder')\r\n  let options = setDefaultOpts(opts)\r\n  const url = buildUrl(options, client)\r\n  let socket = createWebSocket(client, url, options)\r\n  let webSocketStream = WS.createWebSocketStream(socket, options.wsOptions)\r\n  webSocketStream.url = url\r\n  socket.on('close', () => { webSocketStream.destroy() })\r\n  return webSocketStream\r\n}\r\n\r\nfunction browserStreamBuilder (client, opts) {\r\n  debug('browserStreamBuilder')\r\n  let stream\r\n  let options = setDefaultBrowserOpts(opts)\r\n  // sets the maximum socket buffer size before throttling\r\n  const bufferSize = options.browserBufferSize || 1024 * 512\r\n\r\n  const bufferTimeout = opts.browserBufferTimeout || 1000\r\n\r\n  const coerceToBuffer = !opts.objectMode\r\n\r\n  let socket = createBrowserWebSocket(client, opts)\r\n\r\n  let proxy = buildProxy(opts, socketWriteBrowser, socketEndBrowser)\r\n\r\n  if (!opts.objectMode) {\r\n    proxy._writev = writev\r\n  }\r\n  proxy.on('close', () => { socket.close() })\r\n\r\n  const eventListenerSupport = (typeof socket.addEventListener !== 'undefined')\r\n\r\n  // was already open when passed in\r\n  if (socket.readyState === socket.OPEN) {\r\n    stream = proxy\r\n  } else {\r\n    stream = stream = duplexify(undefined, undefined, opts)\r\n    if (!opts.objectMode) {\r\n      stream._writev = writev\r\n    }\r\n\r\n    if (eventListenerSupport) {\r\n      socket.addEventListener('open', onopen)\r\n    } else {\r\n      socket.onopen = onopen\r\n    }\r\n  }\r\n\r\n  stream.socket = socket\r\n\r\n  if (eventListenerSupport) {\r\n    socket.addEventListener('close', onclose)\r\n    socket.addEventListener('error', onerror)\r\n    socket.addEventListener('message', onmessage)\r\n  } else {\r\n    socket.onclose = onclose\r\n    socket.onerror = onerror\r\n    socket.onmessage = onmessage\r\n  }\r\n\r\n  // methods for browserStreamBuilder\r\n\r\n  function buildProxy (options, socketWrite, socketEnd) {\r\n    let proxy = new Transform({\r\n      objectModeMode: options.objectMode\r\n    })\r\n\r\n    proxy._write = socketWrite\r\n    proxy._flush = socketEnd\r\n\r\n    return proxy\r\n  }\r\n\r\n  function onopen () {\r\n    stream.setReadable(proxy)\r\n    stream.setWritable(proxy)\r\n    stream.emit('connect')\r\n  }\r\n\r\n  function onclose () {\r\n    stream.end()\r\n    stream.destroy()\r\n  }\r\n\r\n  function onerror (err) {\r\n    stream.destroy(err)\r\n  }\r\n\r\n  function onmessage (event) {\r\n    let data = event.data\r\n    if (data instanceof ArrayBuffer) data = Buffer.from(data)\r\n    else data = Buffer.from(data, 'utf8')\r\n    proxy.push(data)\r\n  }\r\n\r\n  // this is to be enabled only if objectMode is false\r\n  function writev (chunks, cb) {\r\n    const buffers = new Array(chunks.length)\r\n    for (let i = 0; i < chunks.length; i++) {\r\n      if (typeof chunks[i].chunk === 'string') {\r\n        buffers[i] = Buffer.from(chunks[i], 'utf8')\r\n      } else {\r\n        buffers[i] = chunks[i].chunk\r\n      }\r\n    }\r\n\r\n    this._write(Buffer.concat(buffers), 'binary', cb)\r\n  }\r\n\r\n  function socketWriteBrowser (chunk, enc, next) {\r\n    if (socket.bufferedAmount > bufferSize) {\r\n      // throttle data until buffered amount is reduced.\r\n      setTimeout(socketWriteBrowser, bufferTimeout, chunk, enc, next)\r\n    }\r\n\r\n    if (coerceToBuffer && typeof chunk === 'string') {\r\n      chunk = Buffer.from(chunk, 'utf8')\r\n    }\r\n\r\n    try {\r\n      socket.send(chunk)\r\n    } catch (err) {\r\n      return next(err)\r\n    }\r\n\r\n    next()\r\n  }\r\n\r\n  function socketEndBrowser (done) {\r\n    socket.close()\r\n    done()\r\n  }\r\n\r\n  // end methods for browserStreamBuilder\r\n\r\n  return stream\r\n}\r\n\r\nif (IS_BROWSER) {\r\n  module.exports = browserStreamBuilder\r\n} else {\r\n  module.exports = streamBuilder\r\n}\r\n"]},"metadata":{},"sourceType":"script"}